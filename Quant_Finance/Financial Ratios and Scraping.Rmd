---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

http://rstudio-pubs-static.s3.amazonaws.com/412492_467fbd5be29b45cb8ab66621f59caa0c.html#fix-the-problem--include-nearby-values

```{r}
getwd()
```


```{r}
library(tidyverse) #contains many important packages and functions, such as purrr, ggplot2, etc. 
library(finreportr)
library(rvest) #used for web scraping. 
library(data.table)
library(beepr)
library(kableExtra)
```


To familiarize ourselves with the program, let’s see how many distinct variables the above function returned for Facebook?
```{r}
FB_balance <- GetBalanceSheet('FB', 2018)

FB_balance %>%
  group_by(Metric) %>%
  summarise(
    n=n()
  ) %>%
  kable() %>%
  kable_styling(bootstrap_options = "condensed", latex_options = "scale_down") %>%
  scroll_box(height = "300px")
```

Facebook in 2018 reported 26 variables. How about another company?
```{r}
GetBalanceSheet('BBY', 2018) %>%
  group_by(Metric) %>%
  summarise(
    n=n()
  )   %>%
  kable() %>%
  kable_styling(bootstrap_options = "condensed", latex_options = "scale_down") %>%
  scroll_box(height = "300px")
```

Create a list of Ticker Symbols to run through finreportr.

We need all of the CIKs and Ticker Symbols for our companies of interest; in this case, the S+P 500.

There is a list of all of them on wikipedia, and we can use rvest to get the data.

```{r}
tickers_and_CIKS<- read_html("https://en.wikipedia.org/wiki/List_of_S%26P_500_companies") %>%
  html_node("table.wikitable") %>%
  html_table() %>%
  select('Symbol', "CIK")

head(tickers_and_CIKS, 30) %>%
  kable() %>%
  kable_styling(bootstrap_options = "condensed", latex_options = "scale_down") %>%
  scroll_box(height = "300px")
```

Before we move on, we need to deal with the companies in the S+P which have multiple ticker symbols due to having different classes of shares.

There are two classes of shares for these companies because one class has voting rights and the other does not.
For example, a shareholder owning UAA can vote on the future of Under Armour, while one owning UA cannot.
I am going to choose the ticker that has no voting rights because I am not buying stocks to vote for the company, I am simply hoping for the stock to go up.

```{r}
tickers_and_CIKS %>%
  group_by(CIK) %>%
  mutate(n= n_distinct(`Symbol`)) %>%
  filter(n>1) %>%
  kable() %>%
  kable_styling(bootstrap_options = "condensed", latex_options = "scale_down") %>%
  scroll_box(height = "300px")
```

```{r}
dup_comps <- c("GOOGL", "UAA", "DISCA", "FOX", "NWS") 
tickers_and_CIKS <- tickers_and_CIKS %>%
  filter(!`Symbol` %in% dup_comps)

tickers_and_CIKS<- tibble(tickers_and_CIKS)
```


Get a list of the annual reports for each Ticker symbol in Tickers and CIKs.

Finreportr requires two things, the company ticker symbol, and the year, to return each unique annual report.

I need to go through each ticker symbol and return the distinct years for which annual reports are available.

Luckily, a function to do this already exists in the finreportr package. I wrap it in my own function that adds in the filing date.

Then, I wrap it in possibly, from the purrr package, so that it doesn’t fail.
```{r}
Annual <- function(x) {
  AnnualReports(x) %>%
  mutate(filing.date= str_c(x, filing.date, sep = ", "))
  }

possibleAnnual <- possibly(Annual, otherwise = NA)

finreportr_outcome <- tickers_and_CIKS$Symbol %>%
  
  modify(possibleAnnual) 

finreportr_outcome[[1]] %>%
  kable() %>%
  kable_styling(bootstrap_options = "condensed", latex_options = "scale_down") %>%
  scroll_box(height = "300px")
```




https://lf0.com/post/financial-ratios-in-r/fundamental-financial-ratios-in-r/







