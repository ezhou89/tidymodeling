---
title: "Tidy Trading"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
getwd()
setwd("~/Box Sync/R_Working_Directory/Quant_Finance")
```


```{r}
library(tidyverse)
library(tidyquant)
library(timetk)
library(tibbletime)
library(scales)
library(highcharter)
library(broom)
library(PerformanceAnalytics)
```


### Strategy 

Buy when SP500 50 day SMA is above the 200 day SMA
Sell when the 50 day SMA is below the 200 day SMA
1) code strategy
2) visualize results and descriptive statistics
3) compare against buy and hold strategies
4) add secondary logic
5) build shiny dashboard
6) DS workflow 

```{r}
# Import Data
# ALWAYS Document where and how the data is imported
# import sp500 and tbill data from yahoo finance using tq_get function

symbols <- c("^GSPC", "^IRX")

prices <- tq_get(symbols, 
                 get = "stock.prices", 
                 from = "1990-01-01")

head(prices)
```

```{r}
# Explore the data

prices %>%
  filter(symbol == "^GSPC") %>%
  hchart(., 
         hcaes(x = date, y = adjusted), 
         type = "line") %>%
  hc_title(text = "GSPC Prices")

```

```{r}
# Calculate Returns
# use mutate function from dplyr

returns <- prices %>%
  select(symbol, date, adjusted) %>%
  spread(symbol, adjusted) %>%
  rename(sp500 = "^GSPC", treas = "^IRX") %>%
  mutate(sp500_returns = log(sp500) - log(lag(sp500)), 
         daily_treas = (1 + (treas/100)) ^ (1/252) - 1)

head(returns)
```

```{r}
# Calculate quick stats

returns %>%
  tq_performance(Ra = sp500_returns, 
                 performance_fun = table.Stats) %>%
  t() %>%
  knitr::kable()
```

#### Other PerformanceAnalytics functions

table.CAPM()
table.Drawdowns()
table.DownsideRisk()

```{r}
prices %>%
  select(symbol, date, adjusted) %>%
  spread(symbol, adjusted) %>%
  rename(sp500 = "^GSPC", treas = "^IRX") %>%
  mutate(sp500_returns = log(sp500) - log(lag(sp500))) %>%
  ggplot() + 
  aes(x = date, y = sp500_returns) + 
  geom_point(color = "cornflowerblue") + 
  scale_x_date(breaks = pretty_breaks(n = 30)) + 
  labs(title = "SP500 daily returns", 
       y = "daily percent") + 
  theme(axis.text.x = element_text(angle = 90))
```


### WHY so much data exploration?

### Moving Avg Strat

calculate rolling moving avg using "rollify()" to run "mean()" function

```{r}
roll_mean_50 <- rollify(mean, window = 50)

roll_mean_200 <- rollify(mean, window = 200)
```

# use mutate() to add moving avg to original data

```{r}
prices %>%
  na.omit() %>%
  select(symbol, date, adjusted) %>%
  spread(symbol, adjusted) %>%
  rename(sp500 = "^GSPC", treas = "^IRX") %>%
  mutate(sma_200 = roll_mean_200(sp500), 
         sma_50 = roll_mean_50(sp500)) %>%
  na.omit() %>%
  tail(5)
```

### let's get systematic

*IF* 50day MA is above 200day MA, buy the market
*ELSE* go to risk free return or put zero 

assume no taxes or trading costs
Buy == get daily return

Need:
1) rolling 50d SMA
2) rolling 200d SMA
3) if_else logic for buy sell signal
4) sp500 daily returns/treasury daily returns
5) apply signal to returns with 

signal = if_else(sma_50 > sma_200, 1, 0)

trend_returns = if_else(lag(signal) == 1, (signal * sp500_returns), daily_treas))

```{r}
prices %>%
  na.omit() %>%
  select(symbol, date, adjusted) %>%
  spread(symbol, adjusted) %>%
  rename(sp500 = "^GSPC", treas = "^IRX") %>%
  mutate(sp500_returns = log(sp500) - log(lag(sp500)), 
         daily_treas = (1 + (treas/100))^(1/252)-1, 
         sma_200 = roll_mean_200(sp500), 
         sma_50 = roll_mean_50(sp500)) %>%
  na.omit() %>%
  #add logic or signal here
  mutate(signal = if_else(sma_50 > sma_200, 1, 0)) %>%
  select(date, signal, sma_50, sma_200) %>%
  filter(signal == 1)
```

```{r}
# Buy/Sell Golden Cross Strat 
prices %>%
  na.omit() %>%
  select(symbol, date, adjusted) %>%
  spread(symbol, adjusted) %>%
  rename(sp500 = "^GSPC", treas = "^IRX") %>%
  mutate(sp500_returns = log(sp500) - log(lag(sp500)), 
         daily_treas = (1 + (treas/100))^(1/252)-1, 
         sma_200 = roll_mean_200(sp500), 
         sma_50 = roll_mean_50(sp500)) %>%
  na.omit() %>%
  #add logic or signal here
  mutate(signal = if_else(sma_50 > sma_200, 1, 0), 
         trend_returns = if_else(lag(signal) == 1, (signal * sp500_returns), daily_treas)) %>%
  select(-treas, -sp500) #%>%
filter(signal == 1)
```

### Create a buy and hold strat
90% in sp500
10% in treasuries

buy_hold_returns = (0.9 * sp500_returns) + (0.1 * daily_treas)

```{r}
### Buy and Hold Strat

prices %>%
  na.omit() %>%
  select(symbol, date, adjusted) %>%
  spread(symbol, adjusted) %>%
  rename(sp500 = "^GSPC", treas = "^IRX") %>%
  mutate(sp500_returns = log(sp500) - log(lag(sp500)), 
         daily_treas = (1 + (treas/100))^(1/252)-1, 
         sma_200 = roll_mean_200(sp500), 
         sma_50 = roll_mean_50(sp500)) %>%
  na.omit() %>%
  #add logic or signal here
  mutate(signal = if_else(sma_50 > sma_200, 1, 0), 
         buy_hold_returns = (0.9 * sp500_returns) + (0.1 * daily_treas), 
         trend_returns = if_else(lag(signal) == 1, (signal * sp500_returns), daily_treas)) %>%
  select(date, trend_returns, buy_hold_returns) %>%
  na.omit()

```

### add column to see dollar growth for asset mixes

add 1 to the daily return and use accumulate()

```{r}
sma_trend_results <- 
  prices %>%
  na.omit() %>%
  select(symbol, date, adjusted) %>%
  spread(symbol, adjusted) %>%
  rename(sp500 = "^GSPC", treas = "^IRX") %>%
  mutate(sma_200 = roll_mean_200(sp500), 
         sma_50 = roll_mean_50(sp500),
         signal = if_else(sma_50 > sma_200, 1, 0), 
         sp500_returns = log(sp500) - log(lag(sp500)), 
         daily_treas = (1 + (treas/100))^(1/252) - 1, 
         buy_hold_returns = (0.9 * sp500_returns) + (0.1 * daily_treas), 
         trend_returns = if_else(lag(signal) == 1, (signal * sp500_returns), daily_treas)) %>%
  na.omit() %>%
  mutate(trend_growth = accumulate(1 + trend_returns, `*`), 
         buy_hold_growth = accumulate(1 + buy_hold_returns, `*`))

sma_trend_results %>% tail()
```

### Visualize trend strategy results

compare dollar growth using select(), then gather() to make tidy

```{r}
sma_trend_results %>%
  select(date, trend_growth, buy_hold_growth) %>%
  gather(strategy, growth, -date) %>%
  hchart(., hcaes(x = date, y = growth, group = strategy), 
         type = "line") %>%
  hc_tooltip(pointFormat = "{point.strategy}: ${point.growth: .2f}")

```


### Table Stats of Strategies

```{r}
sma_trend_results %>%
  select(date, trend_returns, buy_hold_returns) %>%
  gather(strategy, returns, -date) %>%
  group_by(strategy) %>%
  tq_performance(Ra = returns, 
                 performance_fun = table.Stats) %>%
  t() %>%
  knitr::kable()
```

### Add another layer of logic

add a z-score signal for x standard deviations above/below rolling avg

1 - calculate spread
2 - turn to a zscore, number of sd
3 - create a signal (aka if_else statement)


```{r}
trend_z_results <- 
prices %>%
  na.omit() %>%
  select(symbol, date, adjusted) %>%
  spread(symbol, adjusted) %>%
  rename(sp500 = "^GSPC", treas = "^IRX") %>% 
  mutate(sma_200 = roll_mean_200(sp500), 
         sma_50 = roll_mean_50(sp500), 
         sp500_returns = log(sp500) - log(lag(sp500)), 
         daily_treas = (1 + (treas/100))^(1/252) - 1) %>%
  na.omit() %>%
  mutate(trend_signal = if_else(sma_50 > sma_200, 1, 0), 
         z_spread = (sp500 - sma_200), 
         z_score = (z_spread - mean(z_spread))/sd(z_spread), 
         z_signal = if_else(
           lag(z_score, 1) < -0.05 &
             lag(z_score, 2) < -0.05 &
             lag(z_score, 3) < -0.05, 
           0, 1),
         trend_z_returns = if_else(lag(trend_signal) == 1 &
                                     z_signal == 1, 
                                   (trend_signal * sp500_returns), daily_treas), 
         trend_returns = if_else(lag(trend_signal) == 1, 
                                 (trend_signal * sp500_returns), daily_treas), 
         buy_hold_returns = (0.9 * sp500_returns) + (0.1 * daily_treas)) %>%
  select(date, trend_signal, z_signal, buy_hold_returns, trend_returns, trend_z_returns, daily_treas) %>%
  na.omit() %>%
  mutate(
    trend_growth = accumulate( 1+ trend_returns, `*`), 
    trend_z_growth = accumulate(1 + trend_z_returns, `*`), 
    buy_hold_growth = accumulate(1 + buy_hold_returns, `*`))

trend_z_results %>% tail()

```

```{r}
trend_z_results %>%
  select(date, trend_growth, trend_z_growth, buy_hold_growth) %>%
  gather(strategy, growth, -date) %>%
  hchart(., hcaes(x = date, y = growth, group = strategy), 
         type = "line") %>%
  hc_tooltip(pointFormat = "{point.strategy}: ${point.growth: .2f}")
```

```{r}
trend_z_results %>%
  select(date, trend_returns, trend_z_returns, buy_hold_returns) %>%
  gather(strategy, returns, -date) %>%
  group_by(strategy) %>%
  tq_performance(Ra = returns, 
                 performance_fun = table.Stats) %>%
  t() %>%
  knitr::kable()
```

### WRAP TO SHINY

```{r}

```




